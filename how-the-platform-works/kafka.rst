
.. _kafka:

Брокер сообщений Kafka
==========================

`Apache Kafka <https://kafka.apache.org/>`_ представляет собой распределённую платформу потоковой передачи данных с открытым исходным кодом. Блокчейн-платформа Waves Enterprise использует Apache Kafka для сбора, хранения и поставки данных блокчейна потребителям. 

Платформа `Apache Kafka <https://kafka.apache.org/>`_ состоит из одного или нескольких кластеров. В свою очередь кластер может включать в себя один или несколько серверов для хранения топиков с сообщениями. На самих серверах может быть запущено от одного серверного процесса по обработке и хранению сообщений, который называется брокером сообщений.

.. _kafka-architecture:

Архитектура взаимодействия брокера сообщений с блокчейн-платформой
----------------------------------------------------------------------

Платформа `Apache Kafka <https://kafka.apache.org/>`_ имеет следующие основные компоненты:

* Кластер - компонент обработки и хранения данных.
* `ZooKeeper <https://zookeeper.apache.org/>`_ - интерфейс координации между брокерами Kafka и потребителями.
* Производитель - поставщик потока данных.
* Потребитель - приложения или процессы, подписанные на получение данных.

 .. figure:: img/kafka-scheme.png
          :scale: 100 %
          :align: center
          :figwidth: 100 %
          :alt: Схема взаимодействия блокчейн-платформы Waves Enterprise и Apache Kafka

          Схема взаимодействия блокчейн-платформы Waves Enterprise и Apache Kafka

Кластер `Apache Kafka <https://kafka.apache.org/>`_ хранит потоки данных, сгруппированные по разделам (topic). Каждая запись состоит из пары ключ-значение и временной метки (key, value, timestamp). Для каждого раздела Kafka ведёт секционированный журнал. Каждая секция журнала представляет собой упорядоченную, неизменяемую последовательность записей, которая постоянно добавляется к секционированному журналу. Каждой записи в секции присваивается уникальный идентификатор, который называется ``offset``. Кластер Kafka сохраняет все опубликованные записи в течение настраиваемого периода хранения независимо от того, были ли они поставлены потребителям или нет. 

`ZooKeeper <https://zookeeper.apache.org/>`_ позволяет распределенным процессам взаимодействовать друг с другом через общее иерархическое пространство имен, организованное аналогично стандартной файловой системе. Пространство имен состоит из регистров данных, похожих на файлы и каталоги, и называемых Z-нодами. Имя - это последовательность элементов пути, разделенная косой чертой (/). Каждая Z-нода в пространстве имен ZooKeeper идентифицируется по этому пути.

Производителем и поставщиком данных является блокчейн-платформа Waves Enterprise. В качестве данных используются все транзакции, попавшие в блок. В структуре каждой записи ключом является высота блокчейна, а значением - `сериализованный <https://en.wikipedia.org/wiki/Serialization>`_ вид всего соержимого блока.

Потребителями данных могут быть любые сервисы и приложения. `Apache Kafka <https://kafka.apache.org/>`_ предоставляет по умолчанию Java-клиент для работы с сообщениями, также клиенты доступны на многих других языках.




